/*!
 * BotBuilder Tours SDK v1.0.0
 * (c) 2026 BotBuilder
 * Released under the MIT License
 *
 * Usage:
 * <script src="https://yourdomain.com/tours-sdk.min.js"><\/script>
 * <script>
 *   BotBuilderTours.init({ apiKey: 'your-api-key' });
 *   BotBuilderTours.startTour('tour-id');
 * </script>
 */
if(function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).BotBuilderTours={})}(this,function(t){"use strict";let e="https://api.botbuilder.app",o=null;function s(t,s){e=t,o=s}async function n(t,s={}){const n=`${e}${t}`,i={"Content-Type":"application/json","X-Workspace-ID":o};try{const t=await fetch(n,{...s,headers:{...i,...s.headers}});if(!t.ok){const e=await t.json().catch(()=>({}));throw new Error(e.message||`HTTP ${t.status}`)}return await t.json()}catch(e){throw console.error(`[TourSDK API] Request failed: ${t}`,e),e}}async function i(t,e={}){const{visitorId:o,userId:s}=e,i=new URLSearchParams({workspaceId:t,url:window.location.pathname});o&&i.append("visitorId",o),s&&i.append("userId",s);return(await n(`/api/public/tours?${i.toString()}`)).tours||[]}async function r(t){const e=await n(`/api/public/tours/${t}`);return e.tour||e}async function l(t){const s={...t,workspaceId:o,timestamp:t.timestamp||(new Date).toISOString(),sessionId:h(),pageUrl:window.location.href,pageTitle:document.title};if(navigator.sendBeacon){const t=new Blob([JSON.stringify(s)],{type:"application/json"});return void navigator.sendBeacon(`${e}/api/public/tours/event`,t)}return n("/api/public/tours/event",{method:"POST",body:JSON.stringify(s)})}async function a(t){return n("/api/public/tours/progress",{method:"POST",body:JSON.stringify({...t,workspaceId:o})})}async function c(t){return n("/api/public/tours/events/batch",{method:"POST",body:JSON.stringify({events:t,workspaceId:o})})}let d=null;function h(){return d||(d=`s_${Date.now().toString(36)}_${Math.random().toString(36).substring(2,8)}`),d}const p=[];let u=navigator.onLine;async function m(){if(0===p.length||!u)return;const t=[...p];p.length=0;try{await c(t)}catch(e){p.push(...t),console.error("[TourSDK] Failed to flush event queue:",e)}}"undefined"!=typeof window&&(window.addEventListener("online",()=>{u=!0,m()}),window.addEventListener("offline",()=>{u=!1})),"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{if(p.length>0&&navigator.sendBeacon){const t=new Blob([JSON.stringify({events:p,workspaceId:o})],{type:"application/json"});navigator.sendBeacon(`${e}/api/public/tours/events/batch`,t)}});const b="bbt_tours_",g=`${b}visitor_id`,_=`${b}progress_`,f=`${b}session`;function v(){return`v_${Date.now().toString(36)}_${Math.random().toString(36).substring(2,10)}`}function w(){try{let t=localStorage.getItem(g);return t||(t=v(),localStorage.setItem(g,t)),t}catch(t){return console.warn("[TourSDK] localStorage not available, using session visitor ID"),v()}}function E(t){try{localStorage.setItem(g,t)}catch(t){console.warn("[TourSDK] Failed to save visitor ID")}}function y(t){try{const e=localStorage.getItem(`${_}${t}`);return e?JSON.parse(e):null}catch(t){return console.warn("[TourSDK] Failed to get progress"),null}}function S(t,e){try{localStorage.setItem(`${_}${t}`,JSON.stringify(e))}catch(t){console.warn("[TourSDK] Failed to save progress")}}function k(t){try{localStorage.removeItem(`${_}${t}`)}catch(t){console.warn("[TourSDK] Failed to clear progress")}}function C(){try{const t=sessionStorage.getItem(f);return t?JSON.parse(t):{}}catch(t){return{}}}function T(t){try{const e=C();sessionStorage.setItem(f,JSON.stringify({...e,...t}))}catch(t){console.warn("[TourSDK] Failed to save session data")}}class I{constructor(t){this.sdk=t,this.toursCache=new Map,this.activeToursCache=null,this.lastFetch=0,this.cacheDuration=3e5}async loadActiveTours(){const t=Date.now();if(this.activeToursCache&&t-this.lastFetch<this.cacheDuration)return this.activeToursCache;try{const e=await i(this.sdk.config.workspaceId,{visitorId:this.sdk.visitorId,userId:this.sdk.userId});return this.activeToursCache=e,this.lastFetch=t,e.forEach(t=>{this.toursCache.set(t.id,t)}),e}catch(t){return console.error("[TourEngine] Failed to load active tours:",t),[]}}async loadTour(t){if(this.toursCache.has(t))return this.toursCache.get(t);try{const e=await r(t);return this.toursCache.set(t,e),e}catch(e){return console.error(`[TourEngine] Failed to load tour ${t}:`,e),null}}checkTargeting(t){if(!t.targeting||!t.targeting.rules||0===t.targeting.rules.length)return!0;const e={url:window.location.href,pathname:window.location.pathname,hostname:window.location.hostname,search:window.location.search,hash:window.location.hash,referrer:document.referrer,userId:this.sdk.userId,visitorId:this.sdk.visitorId,userTraits:this.sdk.userTraits,device:this._getDeviceInfo(),timestamp:Date.now()},{operator:o="AND",rules:s}=t.targeting;return"AND"===o?s.every(t=>this._evaluateRule(t,e)):"OR"!==o||s.some(t=>this._evaluateRule(t,e))}shouldShowTour(t,e){if("active"!==t.status)return!1;if(t.startDate&&new Date(t.startDate)>new Date)return!1;if(t.endDate&&new Date(t.endDate)<new Date)return!1;const o=this.getUserProgress(t.id);if(o){if("completed"===o.status&&!t.settings?.allowReplay)return!1;if("skipped"===o.status&&t.settings?.skipCooldown){const e=new Date(o.updatedAt).getTime()+t.settings.skipCooldown;if(Date.now()<e)return!1}}if(!this.checkTargeting(t))return!1;if(t.pageUrl){const e=window.location.pathname;if("exact"===t.pageUrlMatch){if(e!==t.pageUrl)return!1}else if("contains"===t.pageUrlMatch){if(!e.includes(t.pageUrl))return!1}else if("regex"===t.pageUrlMatch)try{if(!new RegExp(t.pageUrl).test(e))return!1}catch{return!1}}return!0}async trackEvent(t,e){try{await l({eventType:t,...e,visitorId:this.sdk.visitorId,userId:this.sdk.userId,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent})}catch(t){console.error("[TourEngine] Failed to track event:",t)}}getUserProgress(t){return y(t)}async saveProgress(t,e,o){const s={tourId:t,currentStep:e,status:o,visitorId:this.sdk.visitorId,userId:this.sdk.userId,updatedAt:(new Date).toISOString()};S(t,s);try{await a(s)}catch(t){console.error("[TourEngine] Failed to sync progress:",t)}}clearCache(){this.toursCache.clear(),this.activeToursCache=null,this.lastFetch=0}_evaluateRule(t,e){const{type:o,field:s,operator:n,value:i}=t;let r;switch(o){case"url":r=this._getUrlField(s,e);break;case"user":r=this._getUserField(s,e);break;case"device":r=e.device[s];break;case"custom":r=e.userTraits[s];break;default:return!0}return this._compareValues(r,n,i)}_getUrlField(t,e){switch(t){case"pathname":return e.pathname;case"hostname":return e.hostname;case"search":return e.search;case"hash":return e.hash;case"full":default:return e.url;case"referrer":return e.referrer}}_getUserField(t,e){switch(t){case"id":return e.userId;case"visitorId":return e.visitorId;default:return e.userTraits[t]}}_compareValues(t,e,o){if(null==t)return"not_exists"===e||"is_empty"===e;const s=String(t).toLowerCase(),n=String(o).toLowerCase();switch(e){case"equals":return s===n;case"not_equals":return s!==n;case"contains":return s.includes(n);case"not_contains":return!s.includes(n);case"starts_with":return s.startsWith(n);case"ends_with":return s.endsWith(n);case"matches_regex":try{return new RegExp(o,"i").test(t)}catch{return!1}case"greater_than":return Number(t)>Number(o);case"less_than":return Number(t)<Number(o);case"exists":return null!=t;case"not_exists":return null==t;case"is_empty":return""===s;case"is_not_empty":return""!==s;case"in_list":return(Array.isArray(o)?o:o.split(",")).map(t=>t.trim().toLowerCase()).includes(s);case"not_in_list":return!(Array.isArray(o)?o:o.split(",")).map(t=>t.trim().toLowerCase()).includes(s);default:return!0}}_getDeviceInfo(){const t=navigator.userAgent;return{type:this._getDeviceType(t),browser:this._getBrowser(t),os:this._getOS(t),screenWidth:window.screen.width,screenHeight:window.screen.height,language:navigator.language}}_getDeviceType(t){return/tablet|ipad|playbook|silk/i.test(t)?"tablet":/mobile|iphone|ipod|android|blackberry|opera mini|iemobile/i.test(t)?"mobile":"desktop"}_getBrowser(t){return/edge/i.test(t)?"edge":/chrome/i.test(t)?"chrome":/firefox/i.test(t)?"firefox":/safari/i.test(t)?"safari":/msie|trident/i.test(t)?"ie":"unknown"}_getOS(t){return/windows/i.test(t)?"windows":/macintosh|mac os x/i.test(t)?"macos":/linux/i.test(t)?"linux":/android/i.test(t)?"android":/ios|iphone|ipad|ipod/i.test(t)?"ios":"unknown"}}const N=12;function x(t,e,o="bottom"){const s={top:{top:t.top-e.height-N,left:t.left+t.width/2-e.width/2},bottom:{top:t.bottom+N,left:t.left+t.width/2-e.width/2},left:{top:t.top+t.height/2-e.height/2,left:t.left-e.width-N},right:{top:t.top+t.height/2-e.height/2,left:t.right+N}};if("auto"===o){const t=window.innerWidth,n=window.innerHeight,i={top:s.top.top>=0,bottom:s.bottom.top+e.height<=n,left:s.left.left>=0,right:s.right.left+e.width<=t};o=i.bottom?"bottom":i.top?"top":i.right?"right":i.left?"left":"bottom"}const n=s[o]||s.bottom;return{top:n.top,left:n.left,actualPosition:o}}function L(t,e){const o=window.innerWidth,s=window.innerHeight,n=10;let{top:i,left:r}=t;const{width:l,height:a}=e;return r<n?r=n:r+l>o-n&&(r=o-l-n),i<n?i=n:i+a>s-n&&(i=s-a-n),{top:i,left:r}}function B(t){return{top:"bottom",bottom:"top",left:"right",right:"left"}[t]||"top"}class D{constructor(t){this.options={title:"",content:"",position:"bottom",targetElement:null,media:null,buttons:null,stepIndex:0,totalSteps:1,showBackButton:!1,showSkipButton:!0,onNext:()=>{},onPrev:()=>{},onSkip:()=>{},onClose:()=>{},theme:"light",primaryColor:null,...t},this.element=null,this.arrowElement=null,this._resizeHandler=null,this._scrollHandler=null}render(t){this._createTooltip(),t.appendChild(this.element),this._positionTooltip(),this._setupListeners(),this._animateIn()}destroy(){this._removeListeners(),this.element&&this.element.parentNode&&(this.element.classList.add("bbt-tooltip--exit"),setTimeout(()=>{this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element)},200)),this.element=null,this.arrowElement=null}_createTooltip(){const{title:t,content:e,media:o,buttons:s,stepIndex:n,totalSteps:i,showBackButton:r,showSkipButton:l,theme:a,primaryColor:c}=this.options;this.element=document.createElement("div"),this.element.className=`bbt-tooltip bbt-tooltip--${a}`,c&&this.element.style.setProperty("--bbt-primary-color",c),this.arrowElement=document.createElement("div"),this.arrowElement.className="bbt-tooltip__arrow",this.element.appendChild(this.arrowElement);const d=document.createElement("div");d.className="bbt-tooltip__wrapper";const h=document.createElement("button");if(h.className="bbt-tooltip__close",h.innerHTML="&times;",h.setAttribute("aria-label","Close"),h.onclick=t=>{t.preventDefault(),this.options.onClose()},d.appendChild(h),o){const t=this._createMedia(o);d.appendChild(t)}if(t){const e=document.createElement("div");e.className="bbt-tooltip__header";const o=document.createElement("h4");o.className="bbt-tooltip__title",o.textContent=t,e.appendChild(o),d.appendChild(e)}if(e){const t=document.createElement("div");t.className="bbt-tooltip__content",t.innerHTML=e,d.appendChild(t)}const p=document.createElement("div");if(p.className="bbt-tooltip__footer",i>1){const t=document.createElement("span");t.className="bbt-tooltip__progress",t.textContent=`${n+1} / ${i}`,p.appendChild(t)}const u=document.createElement("div");if(u.className="bbt-tooltip__actions",s)s.forEach(t=>{const e=document.createElement("button");e.className=`bbt-btn bbt-btn--${t.variant||"secondary"}`,e.textContent=t.text,e.onclick=e=>{e.preventDefault(),"next"===t.action?this.options.onNext():"prev"===t.action?this.options.onPrev():"skip"===t.action?this.options.onSkip():"close"===t.action?this.options.onClose():t.onClick&&t.onClick()},u.appendChild(e)});else{if(l&&n<i-1){const t=document.createElement("button");t.className="bbt-btn bbt-btn--text",t.textContent="Skip",t.onclick=t=>{t.preventDefault(),this.options.onSkip()},u.appendChild(t)}if(r){const t=document.createElement("button");t.className="bbt-btn bbt-btn--secondary",t.textContent="Back",t.onclick=t=>{t.preventDefault(),this.options.onPrev()},u.appendChild(t)}const t=document.createElement("button");t.className="bbt-btn bbt-btn--primary",t.textContent=n>=i-1?"Done":"Next",t.onclick=t=>{t.preventDefault(),this.options.onNext()},u.appendChild(t)}p.appendChild(u),d.appendChild(p),this.element.appendChild(d)}_createMedia(t){const e=document.createElement("div");if(e.className="bbt-tooltip__media","image"===t.type){const o=document.createElement("img");o.src=t.src,o.alt=t.alt||"",o.className="bbt-tooltip__image",e.appendChild(o)}else if("video"===t.type){const o=document.createElement("video");o.src=t.src,o.controls=!0,o.autoplay=t.autoplay||!1,o.muted=t.muted||!0,o.loop=t.loop||!1,o.className="bbt-tooltip__video",e.appendChild(o)}else if("embed"===t.type){const o=document.createElement("iframe");o.src=t.src,o.className="bbt-tooltip__embed",o.allowFullscreen=!0,e.appendChild(o)}return e}_positionTooltip(){const{targetElement:t,position:e}=this.options;if(!t)return this.element.style.position="fixed",this.element.style.top="50%",this.element.style.left="50%",this.element.style.transform="translate(-50%, -50%)",void(this.arrowElement.style.display="none");const o=t.getBoundingClientRect(),s=this.element.getBoundingClientRect(),{top:n,left:i,actualPosition:r}=x(o,s,e),l=L({top:n,left:i},{width:s.width,height:s.height});this.element.style.position="fixed",this.element.style.top=`${l.top}px`,this.element.style.left=`${l.left}px`;const a=B(r);this.arrowElement.className=`bbt-tooltip__arrow bbt-tooltip__arrow--${a}`}_setupListeners(){this._resizeHandler=()=>this._positionTooltip(),this._scrollHandler=()=>this._positionTooltip(),window.addEventListener("resize",this._resizeHandler),window.addEventListener("scroll",this._scrollHandler,!0),this._keyHandler=t=>{"Escape"===t.key?this.options.onClose():"ArrowRight"===t.key||"Enter"===t.key?this.options.onNext():"ArrowLeft"===t.key&&this.options.onPrev()},document.addEventListener("keydown",this._keyHandler)}_removeListeners(){this._resizeHandler&&window.removeEventListener("resize",this._resizeHandler),this._scrollHandler&&window.removeEventListener("scroll",this._scrollHandler,!0),this._keyHandler&&document.removeEventListener("keydown",this._keyHandler)}_animateIn(){requestAnimationFrame(()=>{this.element.classList.add("bbt-tooltip--enter")})}}class H{constructor(t){this.options={title:"",content:"",size:"medium",media:null,buttons:null,stepIndex:0,totalSteps:1,showBackButton:!1,showSkipButton:!0,onNext:()=>{},onPrev:()=>{},onSkip:()=>{},onClose:()=>{},theme:"light",primaryColor:null,closeOnBackdrop:!0,closeOnEscape:!0,...t},this.element=null,this.backdropElement=null,this._keyHandler=null}render(t){this._createBackdrop(),this._createModal(),t.appendChild(this.backdropElement),t.appendChild(this.element),this._setupListeners(),this._animateIn(),this.element.focus()}destroy(){this._removeListeners(),this.element&&this.element.classList.add("bbt-modal--exit"),this.backdropElement&&this.backdropElement.classList.add("bbt-modal-backdrop--exit"),setTimeout(()=>{this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.backdropElement&&this.backdropElement.parentNode&&this.backdropElement.parentNode.removeChild(this.backdropElement)},200),this.element=null,this.backdropElement=null}_createBackdrop(){this.backdropElement=document.createElement("div"),this.backdropElement.className=`bbt-modal-backdrop bbt-modal-backdrop--${this.options.theme}`,this.options.closeOnBackdrop&&(this.backdropElement.onclick=t=>{t.target===this.backdropElement&&this.options.onClose()})}_createModal(){const{title:t,content:e,size:o,media:s,buttons:n,stepIndex:i,totalSteps:r,showBackButton:l,showSkipButton:a,theme:c,primaryColor:d}=this.options;this.element=document.createElement("div"),this.element.className=`bbt-modal bbt-modal--${o} bbt-modal--${c}`,this.element.setAttribute("role","dialog"),this.element.setAttribute("aria-modal","true"),this.element.setAttribute("tabindex","-1"),d&&this.element.style.setProperty("--bbt-primary-color",d);const h=document.createElement("button");if(h.className="bbt-modal__close",h.innerHTML="&times;",h.setAttribute("aria-label","Close"),h.onclick=t=>{t.preventDefault(),this.options.onClose()},this.element.appendChild(h),s){const t=this._createMedia(s);this.element.appendChild(t)}if(t){const e=document.createElement("div");e.className="bbt-modal__header";const o=document.createElement("h3");o.className="bbt-modal__title",o.textContent=t,e.appendChild(o),this.element.appendChild(e)}if(e){const t=document.createElement("div");t.className="bbt-modal__body",t.innerHTML=e,this.element.appendChild(t)}const p=document.createElement("div");if(p.className="bbt-modal__footer",r>1){const t=document.createElement("div");t.className="bbt-modal__progress";for(let e=0;e<r;e++){const o=document.createElement("span");o.className=`bbt-modal__progress-dot ${e===i?"bbt-modal__progress-dot--active":""} ${e<i?"bbt-modal__progress-dot--completed":""}`,t.appendChild(o)}p.appendChild(t)}const u=document.createElement("div");if(u.className="bbt-modal__actions",n)n.forEach(t=>{const e=document.createElement("button");e.className=`bbt-btn bbt-btn--${t.variant||"secondary"}`,e.textContent=t.text,e.onclick=e=>{e.preventDefault(),"next"===t.action?this.options.onNext():"prev"===t.action?this.options.onPrev():"skip"===t.action?this.options.onSkip():"close"===t.action?this.options.onClose():t.onClick&&t.onClick()},u.appendChild(e)});else{if(a&&i<r-1){const t=document.createElement("button");t.className="bbt-btn bbt-btn--text",t.textContent="Skip tour",t.onclick=t=>{t.preventDefault(),this.options.onSkip()},u.appendChild(t)}if(l){const t=document.createElement("button");t.className="bbt-btn bbt-btn--secondary",t.textContent="Back",t.onclick=t=>{t.preventDefault(),this.options.onPrev()},u.appendChild(t)}const t=document.createElement("button");t.className="bbt-btn bbt-btn--primary",t.textContent=i>=r-1?"Get Started":"Next",t.onclick=t=>{t.preventDefault(),this.options.onNext()},u.appendChild(t)}p.appendChild(u),this.element.appendChild(p)}_createMedia(t){const e=document.createElement("div");if(e.className="bbt-modal__media","image"===t.type){const o=document.createElement("img");o.src=t.src,o.alt=t.alt||"",o.className="bbt-modal__image",e.appendChild(o)}else if("video"===t.type){const o=document.createElement("video");o.src=t.src,o.controls=!0,o.autoplay=t.autoplay||!1,o.muted=!1!==t.muted,o.loop=t.loop||!1,o.className="bbt-modal__video",e.appendChild(o)}else if("embed"===t.type){const o=document.createElement("iframe");o.src=t.src,o.className="bbt-modal__embed",o.allowFullscreen=!0,e.appendChild(o)}else if("lottie"===t.type){const o=document.createElement("div");o.className="bbt-modal__lottie",o.setAttribute("data-lottie-src",t.src),e.appendChild(o)}return e}_setupListeners(){this.options.closeOnEscape&&(this._keyHandler=t=>{"Escape"===t.key?this.options.onClose():"ArrowRight"===t.key||"Enter"===t.key?this.options.onNext():"ArrowLeft"===t.key&&this.options.onPrev()},document.addEventListener("keydown",this._keyHandler))}_removeListeners(){this._keyHandler&&document.removeEventListener("keydown",this._keyHandler)}_animateIn(){requestAnimationFrame(()=>{this.backdropElement.classList.add("bbt-modal-backdrop--enter"),this.element.classList.add("bbt-modal--enter")})}}class P{constructor(t){this.options={targetElement:null,title:"",content:"",position:"right",color:null,pulse:!0,triggerOn:"click",stepIndex:0,totalSteps:1,showBackButton:!1,showSkipButton:!0,onNext:()=>{},onPrev:()=>{},onSkip:()=>{},onClose:()=>{},theme:"light",primaryColor:null,...t},this.hotspotElement=null,this.tooltipElement=null,this.isTooltipVisible=!1,this._resizeHandler=null,this._scrollHandler=null}render(t){this._createHotspot(),this._createTooltip(),t.appendChild(this.hotspotElement),t.appendChild(this.tooltipElement),this._positionHotspot(),this._setupListeners(),this._animateIn()}destroy(){this._removeListeners(),this.hotspotElement&&this.hotspotElement.classList.add("bbt-hotspot--exit"),this.tooltipElement&&this.tooltipElement.classList.add("bbt-hotspot-tooltip--exit"),setTimeout(()=>{this.hotspotElement&&this.hotspotElement.parentNode&&this.hotspotElement.parentNode.removeChild(this.hotspotElement),this.tooltipElement&&this.tooltipElement.parentNode&&this.tooltipElement.parentNode.removeChild(this.tooltipElement)},200),this.hotspotElement=null,this.tooltipElement=null}_createHotspot(){const{color:t,pulse:e,theme:o,primaryColor:s}=this.options;this.hotspotElement=document.createElement("div"),this.hotspotElement.className=`bbt-hotspot bbt-hotspot--${o}`,e&&this.hotspotElement.classList.add("bbt-hotspot--pulse");const n=document.createElement("div");n.className="bbt-hotspot__dot",(t||s)&&(n.style.backgroundColor=t||s);const i=document.createElement("div");i.className="bbt-hotspot__ring",(t||s)&&(i.style.borderColor=t||s),this.hotspotElement.appendChild(n),this.hotspotElement.appendChild(i)}_createTooltip(){const{title:t,content:e,stepIndex:o,totalSteps:s,showBackButton:n,showSkipButton:i,theme:r,primaryColor:l}=this.options;this.tooltipElement=document.createElement("div"),this.tooltipElement.className=`bbt-hotspot-tooltip bbt-hotspot-tooltip--${r}`,this.tooltipElement.style.display="none",l&&this.tooltipElement.style.setProperty("--bbt-primary-color",l);const a=document.createElement("div");a.className="bbt-hotspot-tooltip__arrow",this.tooltipElement.appendChild(a);const c=document.createElement("button");c.className="bbt-hotspot-tooltip__close",c.innerHTML="&times;",c.onclick=t=>{t.preventDefault(),t.stopPropagation(),this.options.onClose()},this.tooltipElement.appendChild(c);const d=document.createElement("div");if(d.className="bbt-hotspot-tooltip__wrapper",t){const e=document.createElement("h4");e.className="bbt-hotspot-tooltip__title",e.textContent=t,d.appendChild(e)}if(e){const t=document.createElement("div");t.className="bbt-hotspot-tooltip__content",t.innerHTML=e,d.appendChild(t)}const h=document.createElement("div");if(h.className="bbt-hotspot-tooltip__footer",s>1){const t=document.createElement("span");t.className="bbt-hotspot-tooltip__progress",t.textContent=`${o+1} / ${s}`,h.appendChild(t)}const p=document.createElement("div");if(p.className="bbt-hotspot-tooltip__actions",i&&o<s-1){const t=document.createElement("button");t.className="bbt-btn bbt-btn--text bbt-btn--sm",t.textContent="Skip",t.onclick=t=>{t.preventDefault(),t.stopPropagation(),this.options.onSkip()},p.appendChild(t)}if(n){const t=document.createElement("button");t.className="bbt-btn bbt-btn--secondary bbt-btn--sm",t.textContent="Back",t.onclick=t=>{t.preventDefault(),t.stopPropagation(),this.options.onPrev()},p.appendChild(t)}const u=document.createElement("button");u.className="bbt-btn bbt-btn--primary bbt-btn--sm",u.textContent=o>=s-1?"Done":"Next",u.onclick=t=>{t.preventDefault(),t.stopPropagation(),this.options.onNext()},p.appendChild(u),h.appendChild(p),d.appendChild(h),this.tooltipElement.appendChild(d)}_positionHotspot(){const{targetElement:t,position:e}=this.options;if(!t)return;const o=t.getBoundingClientRect();let s,n;switch(e){case"top":s=o.top-12,n=o.left+o.width/2;break;case"bottom":s=o.bottom+12,n=o.left+o.width/2;break;case"left":s=o.top+o.height/2,n=o.left-12;break;default:s=o.top+o.height/2,n=o.right+12}this.hotspotElement.style.position="fixed",this.hotspotElement.style.top=`${s}px`,this.hotspotElement.style.left=`${n}px`}_positionTooltip(){if(!this.isTooltipVisible)return;const t=this.hotspotElement.getBoundingClientRect(),e=this.tooltipElement.getBoundingClientRect(),{top:o,left:s,actualPosition:n}=x(t,e,"right"===this.options.position?"right":"bottom"),i=L({top:o,left:s},{width:e.width,height:e.height});this.tooltipElement.style.position="fixed",this.tooltipElement.style.top=`${i.top}px`,this.tooltipElement.style.left=`${i.left}px`;const r=this.tooltipElement.querySelector(".bbt-hotspot-tooltip__arrow");r&&(r.className=`bbt-hotspot-tooltip__arrow bbt-hotspot-tooltip__arrow--${B(n)}`)}_showTooltip(){this.isTooltipVisible||(this.isTooltipVisible=!0,this.tooltipElement.style.display="block",requestAnimationFrame(()=>{this._positionTooltip(),this.tooltipElement.classList.add("bbt-hotspot-tooltip--enter")}))}_hideTooltip(){this.isTooltipVisible&&(this.isTooltipVisible=!1,this.tooltipElement.classList.remove("bbt-hotspot-tooltip--enter"),this.tooltipElement.classList.add("bbt-hotspot-tooltip--exit"),setTimeout(()=>{this.tooltipElement.style.display="none",this.tooltipElement.classList.remove("bbt-hotspot-tooltip--exit")},200))}_toggleTooltip(){this.isTooltipVisible?this._hideTooltip():this._showTooltip()}_setupListeners(){const{triggerOn:t}=this.options;"click"===t?this.hotspotElement.onclick=t=>{t.preventDefault(),t.stopPropagation(),this._toggleTooltip()}:"hover"===t&&(this.hotspotElement.onmouseenter=()=>this._showTooltip(),this.hotspotElement.onmouseleave=()=>{setTimeout(()=>{this.tooltipElement.matches(":hover")||this._hideTooltip()},100)},this.tooltipElement.onmouseleave=()=>this._hideTooltip()),this._resizeHandler=()=>{this._positionHotspot(),this._positionTooltip()},this._scrollHandler=()=>{this._positionHotspot(),this._positionTooltip()},window.addEventListener("resize",this._resizeHandler),window.addEventListener("scroll",this._scrollHandler,!0),this._clickOutsideHandler=t=>{!this.isTooltipVisible||this.tooltipElement.contains(t.target)||this.hotspotElement.contains(t.target)||this._hideTooltip()},document.addEventListener("click",this._clickOutsideHandler),this._keyHandler=t=>{"Escape"===t.key&&(this.isTooltipVisible?this._hideTooltip():this.options.onClose())},document.addEventListener("keydown",this._keyHandler),setTimeout(()=>{this._showTooltip()},500)}_removeListeners(){this._resizeHandler&&window.removeEventListener("resize",this._resizeHandler),this._scrollHandler&&window.removeEventListener("scroll",this._scrollHandler,!0),this._clickOutsideHandler&&document.removeEventListener("click",this._clickOutsideHandler),this._keyHandler&&document.removeEventListener("keydown",this._keyHandler)}_animateIn(){requestAnimationFrame(()=>{this.hotspotElement.classList.add("bbt-hotspot--enter")})}}class A{constructor(t){this.options={title:"",content:"",position:"right",width:400,media:null,buttons:null,stepIndex:0,totalSteps:1,showBackButton:!1,showSkipButton:!0,onNext:()=>{},onPrev:()=>{},onSkip:()=>{},onClose:()=>{},theme:"light",primaryColor:null,showOverlay:!0,closeOnOverlay:!0,...t},this.element=null,this.overlayElement=null,this._keyHandler=null}render(t){this.options.showOverlay&&(this._createOverlay(),t.appendChild(this.overlayElement)),this._createSlideout(),t.appendChild(this.element),this._setupListeners(),this._animateIn()}destroy(){this._removeListeners(),this.element&&(this.element.classList.remove("bbt-slideout--enter"),this.element.classList.add("bbt-slideout--exit")),this.overlayElement&&(this.overlayElement.classList.remove("bbt-slideout-overlay--enter"),this.overlayElement.classList.add("bbt-slideout-overlay--exit")),setTimeout(()=>{this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.overlayElement&&this.overlayElement.parentNode&&this.overlayElement.parentNode.removeChild(this.overlayElement)},300),this.element=null,this.overlayElement=null}_createOverlay(){this.overlayElement=document.createElement("div"),this.overlayElement.className=`bbt-slideout-overlay bbt-slideout-overlay--${this.options.theme}`,this.options.closeOnOverlay&&(this.overlayElement.onclick=()=>this.options.onClose())}_createSlideout(){const{title:t,content:e,position:o,width:s,media:n,buttons:i,stepIndex:r,totalSteps:l,showBackButton:a,showSkipButton:c,theme:d,primaryColor:h}=this.options;this.element=document.createElement("div"),this.element.className=`bbt-slideout bbt-slideout--${o} bbt-slideout--${d}`,this.element.style.width=`${s}px`,h&&this.element.style.setProperty("--bbt-primary-color",h);const p=document.createElement("div");if(p.className="bbt-slideout__header",t){const e=document.createElement("h3");e.className="bbt-slideout__title",e.textContent=t,p.appendChild(e)}const u=document.createElement("button");u.className="bbt-slideout__close",u.innerHTML="&times;",u.setAttribute("aria-label","Close"),u.onclick=t=>{t.preventDefault(),this.options.onClose()},p.appendChild(u),this.element.appendChild(p);const m=document.createElement("div");if(m.className="bbt-slideout__body",n){const t=this._createMedia(n);m.appendChild(t)}if(e){const t=document.createElement("div");t.className="bbt-slideout__content",t.innerHTML=e,m.appendChild(t)}this.element.appendChild(m);const b=document.createElement("div");if(b.className="bbt-slideout__footer",l>1){const t=document.createElement("div");t.className="bbt-slideout__progress";const e=document.createElement("div");e.className="bbt-slideout__progress-bar";const o=document.createElement("div");o.className="bbt-slideout__progress-fill",o.style.width=(r+1)/l*100+"%",e.appendChild(o),t.appendChild(e);const s=document.createElement("span");s.className="bbt-slideout__progress-text",s.textContent=`Step ${r+1} of ${l}`,t.appendChild(s),b.appendChild(t)}const g=document.createElement("div");if(g.className="bbt-slideout__actions",i)i.forEach(t=>{const e=document.createElement("button");e.className=`bbt-btn bbt-btn--${t.variant||"secondary"}`,e.textContent=t.text,e.onclick=e=>{e.preventDefault(),"next"===t.action?this.options.onNext():"prev"===t.action?this.options.onPrev():"skip"===t.action?this.options.onSkip():"close"===t.action?this.options.onClose():t.onClick&&t.onClick()},g.appendChild(e)});else{if(c&&r<l-1){const t=document.createElement("button");t.className="bbt-btn bbt-btn--text",t.textContent="Skip tour",t.onclick=t=>{t.preventDefault(),this.options.onSkip()},g.appendChild(t)}const t=document.createElement("div");if(t.className="bbt-slideout__button-group",a){const e=document.createElement("button");e.className="bbt-btn bbt-btn--secondary",e.textContent="Back",e.onclick=t=>{t.preventDefault(),this.options.onPrev()},t.appendChild(e)}const e=document.createElement("button");e.className="bbt-btn bbt-btn--primary",e.textContent=r>=l-1?"Finish":"Continue",e.onclick=t=>{t.preventDefault(),this.options.onNext()},t.appendChild(e),g.appendChild(t)}b.appendChild(g),this.element.appendChild(b)}_createMedia(t){const e=document.createElement("div");if(e.className="bbt-slideout__media","image"===t.type){const o=document.createElement("img");o.src=t.src,o.alt=t.alt||"",o.className="bbt-slideout__image",e.appendChild(o)}else if("video"===t.type){const o=document.createElement("video");o.src=t.src,o.controls=!0,o.autoplay=t.autoplay||!1,o.muted=!1!==t.muted,o.loop=t.loop||!1,o.className="bbt-slideout__video",e.appendChild(o)}else if("embed"===t.type){const o=document.createElement("iframe");o.src=t.src,o.className="bbt-slideout__embed",o.allowFullscreen=!0,e.appendChild(o)}return e}_setupListeners(){this._keyHandler=t=>{"Escape"===t.key?this.options.onClose():"ArrowRight"===t.key||"Enter"===t.key?this.options.onNext():"ArrowLeft"===t.key&&this.options.onPrev()},document.addEventListener("keydown",this._keyHandler)}_removeListeners(){this._keyHandler&&document.removeEventListener("keydown",this._keyHandler)}_animateIn(){requestAnimationFrame(()=>{this.overlayElement&&this.overlayElement.classList.add("bbt-slideout-overlay--enter"),this.element.classList.add("bbt-slideout--enter")})}}class ${constructor(t){this.options={targetElement:null,onClick:null,padding:8,opacity:.5,theme:"light",borderRadius:4,...t},this.element=null,this.spotlightElement=null,this._resizeHandler=null,this._scrollHandler=null}render(t){this._createOverlay(),t.appendChild(this.element),this._updateSpotlight(),this._setupListeners(),this._animateIn()}destroy(){this._removeListeners(),this.element&&(this.element.classList.remove("bbt-overlay--enter"),this.element.classList.add("bbt-overlay--exit"),setTimeout(()=>{this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element)},200)),this.element=null,this.spotlightElement=null}_createOverlay(){const{theme:t,opacity:e,onClick:o}=this.options;this.element=document.createElement("div"),this.element.className=`bbt-overlay bbt-overlay--${t}`;const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("class","bbt-overlay__svg"),s.setAttribute("width","100%"),s.setAttribute("height","100%");const n=document.createElementNS("http://www.w3.org/2000/svg","defs"),i=document.createElementNS("http://www.w3.org/2000/svg","mask");i.setAttribute("id","bbt-spotlight-mask");const r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("x","0"),r.setAttribute("y","0"),r.setAttribute("width","100%"),r.setAttribute("height","100%"),r.setAttribute("fill","white"),i.appendChild(r),this.spotlightElement=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.spotlightElement.setAttribute("class","bbt-overlay__spotlight"),this.spotlightElement.setAttribute("fill","black"),this.spotlightElement.setAttribute("rx",this.options.borderRadius),this.spotlightElement.setAttribute("ry",this.options.borderRadius),i.appendChild(this.spotlightElement),n.appendChild(i),s.appendChild(n);const l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("x","0"),l.setAttribute("y","0"),l.setAttribute("width","100%"),l.setAttribute("height","100%"),l.setAttribute("fill","dark"===t?"rgba(255, 255, 255, 0.1)":`rgba(0, 0, 0, ${e})`),l.setAttribute("mask","url(#bbt-spotlight-mask)"),s.appendChild(l),this.element.appendChild(s),o&&(this.element.onclick=t=>{t.target!==this.element&&"svg"!==t.target.tagName&&"rect"!==t.target.tagName||o()})}_updateSpotlight(){const{targetElement:t,padding:e}=this.options;if(!t||!this.spotlightElement)return this.spotlightElement.setAttribute("width","0"),void this.spotlightElement.setAttribute("height","0");const o=t.getBoundingClientRect();this.spotlightElement.setAttribute("x",o.left-e),this.spotlightElement.setAttribute("y",o.top-e),this.spotlightElement.setAttribute("width",o.width+2*e),this.spotlightElement.setAttribute("height",o.height+2*e)}_setupListeners(){this._resizeHandler=()=>this._updateSpotlight(),this._scrollHandler=()=>this._updateSpotlight(),window.addEventListener("resize",this._resizeHandler),window.addEventListener("scroll",this._scrollHandler,!0)}_removeListeners(){this._resizeHandler&&window.removeEventListener("resize",this._resizeHandler),this._scrollHandler&&window.removeEventListener("scroll",this._scrollHandler,!0)}_animateIn(){requestAnimationFrame(()=>{this.element.classList.add("bbt-overlay--enter")})}}class O{constructor(t){this.options={current:0,total:1,theme:"light",position:"bottom",showStepNumbers:!0,primaryColor:null,...t},this.element=null}render(t){this._createProgressBar(),t.appendChild(this.element),this._animateIn()}destroy(){this.element&&(this.element.classList.remove("bbt-progress-bar--enter"),this.element.classList.add("bbt-progress-bar--exit"),setTimeout(()=>{this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element)},200)),this.element=null}update(t){this.options.current=t,this._updateProgress()}_createProgressBar(){const{current:t,total:e,theme:o,position:s,showStepNumbers:n,primaryColor:i}=this.options;this.element=document.createElement("div"),this.element.className=`bbt-progress-bar bbt-progress-bar--${s} bbt-progress-bar--${o}`,i&&this.element.style.setProperty("--bbt-primary-color",i);const r=document.createElement("div");r.className="bbt-progress-bar__track";for(let o=0;o<e;o++){const s=document.createElement("div");if(s.className="bbt-progress-bar__step",o<t?s.classList.add("bbt-progress-bar__step--completed"):o===t&&s.classList.add("bbt-progress-bar__step--active"),o<e-1){const e=document.createElement("div");e.className="bbt-progress-bar__connector",o<t&&e.classList.add("bbt-progress-bar__connector--completed"),s.appendChild(e)}const i=document.createElement("div");i.className="bbt-progress-bar__dot",n&&(i.textContent=o+1),s.appendChild(i),r.appendChild(s)}this.element.appendChild(r);const l=document.createElement("div");l.className="bbt-progress-bar__text",l.textContent=`Step ${t+1} of ${e}`,this.element.appendChild(l)}_updateProgress(){const{current:t,total:e}=this.options;this.element.querySelectorAll(".bbt-progress-bar__step").forEach((e,o)=>{e.classList.remove("bbt-progress-bar__step--completed","bbt-progress-bar__step--active"),o<t?e.classList.add("bbt-progress-bar__step--completed"):o===t&&e.classList.add("bbt-progress-bar__step--active")});this.element.querySelectorAll(".bbt-progress-bar__connector").forEach((e,o)=>{e.classList.toggle("bbt-progress-bar__connector--completed",o<t)});const o=this.element.querySelector(".bbt-progress-bar__text");o&&(o.textContent=`Step ${t+1} of ${e}`)}_animateIn(){requestAnimationFrame(()=>{this.element.classList.add("bbt-progress-bar--enter")})}}function z(t){if(!t)return null;try{if(t.startsWith("data-tour=")){const e=t.replace("data-tour=","");return document.querySelector(`[data-tour="${e}"]`)}if(t.startsWith("data-tour-id=")){const e=t.replace("data-tour-id=","");return document.querySelector(`[data-tour-id="${e}"]`)}return document.querySelector(t)}catch(e){return console.error("[TourSDK] Invalid selector:",t,e),null}}function F(t){if(!t)return!1;const e=t.getBoundingClientRect(),o=window.getComputedStyle(t);if(0===e.width||0===e.height)return!1;if("none"===o.display)return!1;if("hidden"===o.visibility)return!1;if(0===parseFloat(o.opacity))return!1;const s=window.innerHeight||document.documentElement.clientHeight,n=window.innerWidth||document.documentElement.clientWidth;return e.top>=-e.height&&e.left>=-e.width&&e.bottom<=s+e.height&&e.right<=n+e.width}function R(t){if(!t)return!1;const e=t.getBoundingClientRect(),o=window.innerHeight||document.documentElement.clientHeight,s=window.innerWidth||document.documentElement.clientWidth;return e.top>=0&&e.left>=0&&e.bottom<=o&&e.right<=s}function M(t,e={}){return new Promise(o=>{if(!t)return void o();const{behavior:s="smooth",block:n="center",inline:i="nearest",offset:r=0}=e;if(R(t))return void o();t.scrollIntoView({behavior:s,block:n,inline:i}),0!==r&&setTimeout(()=>{window.scrollBy({top:r,behavior:"smooth"})},100);setTimeout(o,"smooth"===s?500:100)})}function K(t,e=5e3){return new Promise(o=>{const s=z(t);if(s)return void o(s);const n=Date.now(),i=new MutationObserver((s,i)=>{const r=z(t);r?(i.disconnect(),o(r)):Date.now()-n>=e&&(i.disconnect(),o(null))});i.observe(document.body,{childList:!0,subtree:!0,attributes:!0}),setTimeout(()=>{i.disconnect(),o(z(t))},e)})}function q(t){const e=["a[href]","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(", ");return Array.from(t.querySelectorAll(e))}class U{constructor(t){this.sdk=t,this.container=null,this.currentComponent=null,this.overlay=null,this.progressBar=null,this.hotspots=[],this._createContainer()}async renderStep(t,e){this._cleanup();const{tour:o,stepIndex:s,totalSteps:n,onNext:i,onPrev:r,onSkip:l,onClose:a}=e;let c=null;t.targetSelector&&(c=await K(t.targetSelector,t.waitTimeout||5e3),c||(console.warn(`[TourRenderer] Target element not found: ${t.targetSelector}`),t.type="modal")),c&&!1!==t.scrollTo&&await M(c,{behavior:t.scrollBehavior||"smooth",block:t.scrollBlock||"center"}),!1!==t.overlay&&c&&(this.overlay=new $({targetElement:c,onClick:t.overlayClickClose?a:null,padding:t.overlayPadding||8,opacity:t.overlayOpacity||.5,theme:this.sdk.config.theme}),this.overlay.render(this.container)),!1!==o.settings?.showProgress&&n>1&&(this.progressBar=new O({current:s,total:n,theme:this.sdk.config.theme}),this.progressBar.render(this.container));const d={step:t,targetElement:c,stepIndex:s,totalSteps:n,onNext:i,onPrev:r,onSkip:l,onClose:a,showBackButton:s>0&&!1!==o.settings?.showBackButton,showSkipButton:!1!==o.settings?.showSkipButton,theme:this.sdk.config.theme,primaryColor:o.settings?.primaryColor};switch(t.type){case"tooltip":default:this._renderTooltip(d);break;case"modal":this._renderModal(d);break;case"hotspot":this._renderHotspot(d);break;case"slideout":this._renderSlideout(d)}this._setupStepTriggers(t,c,i)}_renderTooltip(t){const{step:e,targetElement:o,...s}=t;this.currentComponent=new D({title:e.title,content:e.content,position:e.position||"bottom",targetElement:o,media:e.media,buttons:e.buttons,...s}),this.currentComponent.render(this.container)}_renderModal(t){const{step:e,...o}=t;this.currentComponent=new H({title:e.title,content:e.content,size:e.size||"medium",media:e.media,buttons:e.buttons,...o}),this.currentComponent.render(this.container)}_renderHotspot(t){const{step:e,targetElement:o,...s}=t;if(!o)return console.warn("[TourRenderer] Hotspot requires a target element"),void this._renderModal(t);this.currentComponent=new P({targetElement:o,title:e.title,content:e.content,position:e.position||"right",color:e.hotspotColor,pulse:!1!==e.pulse,...s}),this.currentComponent.render(this.container)}_renderSlideout(t){const{step:e,...o}=t;this.currentComponent=new A({title:e.title,content:e.content,position:e.slidePosition||"right",width:e.slideWidth,media:e.media,buttons:e.buttons,...o}),this.currentComponent.render(this.container)}_setupStepTriggers(t,e,o){if(!t.trigger||!e)return;const{type:s,event:n}=t.trigger;switch(s){case"click":const t=()=>{e.removeEventListener("click",t),o()};e.addEventListener("click",t),this._triggerCleanup=()=>e.removeEventListener("click",t);break;case"input":const s=()=>{e.value.length>0&&(e.removeEventListener("input",s),o())};e.addEventListener("input",s),this._triggerCleanup=()=>e.removeEventListener("input",s);break;case"custom":if(n){const t=()=>{document.removeEventListener(n,t),o()};document.addEventListener(n,t),this._triggerCleanup=()=>document.removeEventListener(n,t)}}}destroy(){this._cleanup(),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),this.container=null}_createContainer(){const t=document.getElementById("botbuilder-tours-container");t&&t.parentNode.removeChild(t),this.container=document.createElement("div"),this.container.id="botbuilder-tours-container",this.container.className="botbuilder-tours",document.body.appendChild(this.container)}_cleanup(){this.currentComponent&&(this.currentComponent.destroy(),this.currentComponent=null),this.overlay&&(this.overlay.destroy(),this.overlay=null),this.progressBar&&(this.progressBar.destroy(),this.progressBar=null),this.hotspots.forEach(t=>t.destroy()),this.hotspots=[],this._triggerCleanup&&(this._triggerCleanup(),this._triggerCleanup=null)}}class V{constructor(){this._events={},this._onceEvents={}}on(t,e){if("function"!=typeof e)throw new Error("Callback must be a function");return this._events[t]||(this._events[t]=[]),this._events[t].push(e),this}once(t,e){if("function"!=typeof e)throw new Error("Callback must be a function");return this._onceEvents[t]||(this._onceEvents[t]=[]),this._onceEvents[t].push(e),this}off(t,e){return this._events[t]&&(this._events[t]=this._events[t].filter(t=>t!==e)),this._onceEvents[t]&&(this._onceEvents[t]=this._onceEvents[t].filter(t=>t!==e)),this}removeAllListeners(t){return t?(delete this._events[t],delete this._onceEvents[t]):(this._events={},this._onceEvents={}),this}emit(t,...e){let o=!1;if(this._events[t]&&(o=!0,this._events[t].forEach(o=>{try{o(...e)}catch(e){console.error(`[EventEmitter] Error in ${t} listener:`,e)}})),this._onceEvents[t]){o=!0;const s=[...this._onceEvents[t]];this._onceEvents[t]=[],s.forEach(o=>{try{o(...e)}catch(e){console.error(`[EventEmitter] Error in ${t} once listener:`,e)}})}return this._events["*"]&&this._events["*"].forEach(o=>{try{o(t,...e)}catch(t){console.error("[EventEmitter] Error in wildcard listener:",t)}}),o}listenerCount(t){return(this._events[t]?.length||0)+(this._onceEvents[t]?.length||0)}eventNames(){const t=new Set([...Object.keys(this._events),...Object.keys(this._onceEvents)]);return Array.from(t)}listeners(t){return[...this._events[t]||[],...this._onceEvents[t]||[]]}}const W={SDK_INITIALIZED:"sdk:initialized",SDK_DESTROYED:"sdk:destroyed",USER_IDENTIFIED:"user:identified",TOUR_STARTED:"tour:started",TOUR_COMPLETED:"tour:completed",TOUR_DISMISSED:"tour:dismissed",TOUR_ERROR:"tour:error",STEP_VIEWED:"step:viewed",STEP_COMPLETED:"step:completed",STEP_SKIPPED:"step:skipped",PROGRESS_SAVED:"progress:saved",PROGRESS_RESET:"progress:reset"};class j extends V{constructor(){super(),this.config=null,this.engine=null,this.renderer=null,this.currentTour=null,this.currentStepIndex=0,this.initialized=!1,this.visitorId=null,this.userId=null,this.userTraits={}}init(t){if(this.initialized)return console.warn("[BotBuilderTours] SDK already initialized"),this;if(!t.workspaceId)throw new Error("[BotBuilderTours] workspaceId is required");return this.config={workspaceId:t.workspaceId,userId:t.userId||null,visitorId:t.visitorId||w(),apiUrl:t.apiUrl||"https://api.botbuilder.app",autoStart:!1!==t.autoStart,theme:t.theme||"light"},this.visitorId=this.config.visitorId,E(this.visitorId),this.config.userId&&(this.userId=this.config.userId),s(this.config.apiUrl,this.config.workspaceId),this.engine=new I(this),this.renderer=new U(this),this._applyTheme(this.config.theme),this.initialized=!0,this.emit("sdk:initialized",{config:this.config}),this.config.autoStart&&this._autoStartTours(),this}identify(t,e={}){if(!this.initialized)throw new Error("[BotBuilderTours] SDK not initialized. Call init() first.");return this.userId=t,this.userTraits={...this.userTraits,...e},this.emit("user:identified",{userId:t,traits:this.userTraits}),this.config.autoStart&&this._autoStartTours(),this}async startTour(t){if(!this.initialized)throw new Error("[BotBuilderTours] SDK not initialized. Call init() first.");if(this.currentTour)console.warn("[BotBuilderTours] A tour is already running. End it first.");else try{const e=await this.engine.loadTour(t);if(!e)return void console.error(`[BotBuilderTours] Tour ${t} not found`);this.currentTour=e,this.currentStepIndex=0;const o=y(t);o&&o.currentStep>0&&(this.currentStepIndex=o.currentStep),this.emit("tour:started",{tour:this.currentTour,stepIndex:this.currentStepIndex}),this.engine.trackEvent("tour_started",{tourId:t}),this._showCurrentStep()}catch(e){console.error("[BotBuilderTours] Failed to start tour:",e),this.emit("tour:error",{tourId:t,error:e})}}endTour(t=!0){if(!this.currentTour)return;const e=this.currentTour,o=t?"tour:completed":"tour:dismissed";this.renderer.destroy(),this.engine.trackEvent(t?"tour_completed":"tour_dismissed",{tourId:e.id,completedSteps:this.currentStepIndex+1,totalSteps:e.steps.length}),t&&this.engine.saveProgress(e.id,e.steps.length-1,"completed"),this.emit(o,{tour:e,completedSteps:this.currentStepIndex+1}),this.currentTour=null,this.currentStepIndex=0}nextStep(){if(!this.currentTour)return;const t=this.currentTour;this.currentStepIndex>=t.steps.length-1?this.endTour(!0):(this.emit("step:completed",{tour:t,step:t.steps[this.currentStepIndex],stepIndex:this.currentStepIndex}),this.currentStepIndex++,this.engine.saveProgress(t.id,this.currentStepIndex,"in_progress"),this._showCurrentStep())}prevStep(){this.currentTour&&0!==this.currentStepIndex&&(this.currentStepIndex--,this._showCurrentStep())}skipTour(){this.currentTour&&(this.engine.saveProgress(this.currentTour.id,this.currentStepIndex,"skipped"),this.endTour(!1))}goToStep(t){this.currentTour&&(t<0||t>=this.currentTour.steps.length?console.warn("[BotBuilderTours] Invalid step index"):(this.currentStepIndex=t,this._showCurrentStep()))}getState(){return{initialized:this.initialized,currentTour:this.currentTour,currentStepIndex:this.currentStepIndex,totalSteps:this.currentTour?.steps.length||0,userId:this.userId,visitorId:this.visitorId}}resetProgress(t){k(t),this.emit("progress:reset",{tourId:t})}destroy(){this.currentTour&&this.endTour(!1),this.renderer&&this.renderer.destroy(),this.removeAllListeners(),this.initialized=!1,this.config=null,this.engine=null,this.renderer=null,this.emit("sdk:destroyed")}_showCurrentStep(){const t=this.currentTour.steps[this.currentStepIndex];this.renderer.renderStep(t,{tour:this.currentTour,stepIndex:this.currentStepIndex,totalSteps:this.currentTour.steps.length,onNext:()=>this.nextStep(),onPrev:()=>this.prevStep(),onSkip:()=>this.skipTour(),onClose:()=>this.endTour(!1)}),this.emit("step:viewed",{tour:this.currentTour,step:t,stepIndex:this.currentStepIndex}),this.engine.trackEvent("step_viewed",{tourId:this.currentTour.id,stepId:t.id,stepIndex:this.currentStepIndex})}async _autoStartTours(){try{const t=await this.engine.loadActiveTours();for(const e of t){const t={url:window.location.href,pathname:window.location.pathname,userId:this.userId,visitorId:this.visitorId,userTraits:this.userTraits};if(this.engine.shouldShowTour(e,t)){await this.startTour(e.id);break}}}catch(t){console.error("[BotBuilderTours] Failed to auto-start tours:",t)}}_applyTheme(t){document.documentElement.setAttribute("data-botbuilder-theme",t)}}const J=new j;"undefined"!=typeof window&&(window.BotBuilderTours=J);const G=J;function X(t){const e={...t,workspaceId:t.workspaceId||t.apiKey};return G.init(e)}function Y(t){return G.startTour(t)}function Z(){return G.endTour(!1)}function Q(){return G.nextStep()}function tt(){return G.prevStep()}function et(t){return G.goToStep(t)}function ot(t){return G.on("tour:completed",t),G}function st(t){return G.on("tour:dismissed",t),G}function nt(t){return G.on("step:viewed",t),G}function it(t){return G.on("step:completed",t),G}function rt(t){return G.on("tour:started",t),G}function lt(t,e){return G.identify(t,e)}function at(){return G.getState()}function ct(t){return G.resetProgress(t)}function dt(){return G.destroy()}function ht(t=!0){return G.endTour(t)}function pt(){return G.skipTour()}var ut={sdk:G,init:X,startTour:Y,stopTour:Z,nextStep:Q,prevStep:tt,goToStep:et,onComplete:ot,onSkip:st,onStepViewed:nt,onStepComplete:it,onStart:rt,identify:lt,getState:at,resetProgress:ct,destroy:dt,endTour:ht,skipTour:pt,TourSDK:j,TourEngine:I,TourRenderer:U,EventEmitter:V,EVENTS:W};t.EVENTS=W,t.EventEmitter=V,t.Highlight=class{constructor(t){this.options={targetElement:null,color:"#3B82F6",borderWidth:2,padding:4,borderRadius:4,pulse:!1,...t},this.element=null,this._resizeHandler=null,this._scrollHandler=null}render(t){this._createHighlight(),t.appendChild(this.element),this._updatePosition(),this._setupListeners(),this._animateIn()}destroy(){this._removeListeners(),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null}_createHighlight(){const{color:t,borderWidth:e,borderRadius:o,pulse:s}=this.options;this.element=document.createElement("div"),this.element.className="bbt-highlight",s&&this.element.classList.add("bbt-highlight--pulse"),this.element.style.border=`${e}px solid ${t}`,this.element.style.borderRadius=`${o}px`,this.element.style.boxShadow=`0 0 0 4px ${t}33`}_updatePosition(){const{targetElement:t,padding:e,borderWidth:o}=this.options;if(!t)return;const s=t.getBoundingClientRect();this.element.style.position="fixed",this.element.style.top=s.top-e-o+"px",this.element.style.left=s.left-e-o+"px",this.element.style.width=`${s.width+2*e}px`,this.element.style.height=`${s.height+2*e}px`}_setupListeners(){this._resizeHandler=()=>this._updatePosition(),this._scrollHandler=()=>this._updatePosition(),window.addEventListener("resize",this._resizeHandler),window.addEventListener("scroll",this._scrollHandler,!0)}_removeListeners(){this._resizeHandler&&window.removeEventListener("resize",this._resizeHandler),this._scrollHandler&&window.removeEventListener("scroll",this._scrollHandler,!0)}_animateIn(){requestAnimationFrame(()=>{this.element.classList.add("bbt-highlight--enter")})}},t.Hotspot=P,t.Modal=H,t.Overlay=$,t.ProgressBar=O,t.ProgressDots=class{constructor(t){this.options={current:0,total:1,theme:"light",primaryColor:null,...t},this.element=null}render(t){this._createDots(),t.appendChild(this.element)}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null}update(t){this.options.current=t,this._updateDots()}_createDots(){const{current:t,total:e,theme:o,primaryColor:s}=this.options;this.element=document.createElement("div"),this.element.className=`bbt-progress-dots bbt-progress-dots--${o}`,s&&this.element.style.setProperty("--bbt-primary-color",s);for(let o=0;o<e;o++){const e=document.createElement("div");e.className="bbt-progress-dots__dot",o<t?e.classList.add("bbt-progress-dots__dot--completed"):o===t&&e.classList.add("bbt-progress-dots__dot--active"),this.element.appendChild(e)}}_updateDots(){const{current:t}=this.options;this.element.querySelectorAll(".bbt-progress-dots__dot").forEach((e,o)=>{e.classList.remove("bbt-progress-dots__dot--completed","bbt-progress-dots__dot--active"),o<t?e.classList.add("bbt-progress-dots__dot--completed"):o===t&&e.classList.add("bbt-progress-dots__dot--active")})}},t.Slideout=A,t.Tooltip=D,t.TourEngine=I,t.TourRenderer=U,t.TourSDK=j,t.adjustForViewport=L,t.batchTrackEvents=c,t.calculateArrowOffset=function(t,e,o){const s="top"===o||"bottom"===o?e.left+e.width/2:e.top+e.height/2;return{offset:("top"===o||"bottom"===o?t.left+t.width/2:t.top+t.height/2)-s,direction:"top"===o||"bottom"===o?"horizontal":"vertical"}},t.calculateModalPosition=function(t,e="center"){const o=window.innerWidth,s=window.innerHeight,n=(o-t.width)/2;let i;switch(e){case"top":i=60;break;case"bottom":i=s-t.height-60;break;default:i=(s-t.height)/2}return{top:i,left:n}},t.calculatePosition=x,t.calculateSlideoutPosition=function(t,e="right"){return{top:0,bottom:0,[e]:0,width:`${t}px`,["right"===e?"left":"right"]:"auto"}},t.checkOverflow=function(t,e){const o=window.innerWidth,s=window.innerHeight;return{overflowTop:t.top<0,overflowRight:t.left+e.width>o,overflowBottom:t.top+e.height>s,overflowLeft:t.left<0}},t.clearAllProgress=function(){try{Object.keys(localStorage).forEach(t=>{t.startsWith(_)&&localStorage.removeItem(t)})}catch(t){console.warn("[TourSDK] Failed to clear all progress")}},t.clearProgress=k,t.clearSession=function(){try{sessionStorage.removeItem(f)}catch(t){console.warn("[TourSDK] Failed to clear session")}},t.createFocusTrap=function(t){const e=q(t),o=e[0],s=e[e.length-1],n=t=>{"Tab"===t.key&&(t.shiftKey?document.activeElement===o&&(t.preventDefault(),s?.focus()):document.activeElement===s&&(t.preventDefault(),o?.focus()))};return t.addEventListener("keydown",n),o?.focus(),()=>{t.removeEventListener("keydown",n)}},t.createTypedEmitter=function(){const t=new V;return{on:(e,o)=>t.on(e,o),once:(e,o)=>t.once(e,o),off:(e,o)=>t.off(e,o),emit:(e,...o)=>t.emit(e,...o),removeAllListeners:e=>t.removeAllListeners(e),EVENTS:W}},t.debounce=function(t,e){let o;return function(...s){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),t(...s)},e)}},t.default=ut,t.destroy=dt,t.dismissTourForSession=function(t){const e=C().dismissed||[];e.includes(t)||(e.push(t),T({dismissed:e}))},t.endTour=ht,t.fetchActiveTours=i,t.fetchProgress=async function(t,e){return n(`/api/public/tours/progress?${new URLSearchParams({tourId:t,visitorId:e}).toString()}`)},t.fetchTour=r,t.findElement=z,t.getAllProgress=function(){try{const t={};return Object.keys(localStorage).forEach(e=>{if(e.startsWith(_)){const o=e.replace(_,""),s=localStorage.getItem(e);s&&(t[o]=JSON.parse(s))}}),t}catch(t){return console.warn("[TourSDK] Failed to get all progress"),{}}},t.getArrowPosition=B,t.getCenteredPosition=function(t){const e=window.innerWidth;return{top:(window.innerHeight-t.height)/2,left:(e-t.width)/2}},t.getCurrentStep=function(t){const e=y(t);return e?.currentStep??0},t.getElementPosition=function(t){if(!t)return null;const e=t.getBoundingClientRect(),o=window.pageXOffset||document.documentElement.scrollLeft,s=window.pageYOffset||document.documentElement.scrollTop;return{top:e.top,left:e.left,right:e.right,bottom:e.bottom,width:e.width,height:e.height,absoluteTop:e.top+s,absoluteLeft:e.left+o,centerX:e.left+e.width/2,centerY:e.top+e.height/2}},t.getFocusableElements=q,t.getOptimalPosition=function(t,e){const o=window.innerWidth,s=window.innerHeight,n=t.top,i=s-t.bottom,r=t.left,l=o-t.right,a={top:{space:n,fits:n>=e.height+N},bottom:{space:i,fits:i>=e.height+N},left:{space:r,fits:r>=e.width+N},right:{space:l,fits:l>=e.width+N}},c=Object.entries(a).filter(([,t])=>t.fits).sort(([,t],[,e])=>e.space-t.space);return c.length>0?c[0][0]:Object.entries(a).sort(([,t],[,e])=>e.space-t.space)[0][0]},t.getProgress=y,t.getSession=C,t.getState=at,t.getStorageInfo=function(){try{let t=0,e=0;for(const o in localStorage)if(localStorage.hasOwnProperty(o)){const s=2*localStorage[o].length;t+=s,o.startsWith(b)&&(e+=s)}return{totalSize:t,tourDataSize:e,totalSizeKB:(t/1024).toFixed(2),tourDataSizeKB:(e/1024).toFixed(2)}}catch(t){return{error:"Unable to calculate storage info"}}},t.getVisitorId=w,t.getZIndex=function(t){let e=t,o=0;for(;e;){const t=window.getComputedStyle(e),s=parseInt(t.zIndex,10);!isNaN(s)&&s>o&&(o=s),e=e.parentElement}return o},t.goToStep=et,t.hasTourBeenSeen=function(t){const e=y(t);return!!e?.seen},t.highlightElement=function(t,e={}){if(!t)return()=>{};const{color:o="#3B82F6",duration:s=0,pulse:n=!1}=e,i=t.style.outline,r=t.style.transition;t.style.outline=`3px solid ${o}`,t.style.transition="outline 0.3s ease",n&&t.classList.add("bbt-pulse-highlight");const l=()=>{t.style.outline=i,t.style.transition=r,t.classList.remove("bbt-pulse-highlight")};return s>0&&setTimeout(l,s),l},t.identify=lt,t.init=X,t.initApi=s,t.initSession=async function(t,e={}){const{visitorId:o,userId:s}=e;return n("/api/public/tours/init",{method:"POST",body:JSON.stringify({workspaceId:t,visitorId:o,userId:s,url:window.location.href,referrer:document.referrer,userAgent:navigator.userAgent,timestamp:(new Date).toISOString()})})},t.isElementFullyVisible=R,t.isElementVisible=F,t.isTourCompleted=function(t){const e=y(t);return"completed"===e?.status},t.isTourDismissedForSession=function(t){const e=C();return e.dismissed?.includes(t)||!1},t.isTourSkipped=function(t){const e=y(t);return"skipped"===e?.status},t.markTourAsSeen=function(t){S(t,{...y(t)||{},seen:!0,seenAt:(new Date).toISOString()})},t.nextStep=Q,t.onComplete=ot,t.onSkip=st,t.onStart=rt,t.onStepComplete=it,t.onStepViewed=nt,t.prevStep=tt,t.queueEvent=function(t){p.push({...t,queuedAt:(new Date).toISOString()}),u&&m()},t.reportError=async function(t){try{return n("/api/public/tours/error",{method:"POST",body:JSON.stringify({...t,workspaceId:o,url:window.location.href,userAgent:navigator.userAgent,timestamp:(new Date).toISOString()})})}catch(t){console.error("[TourSDK] Failed to report error:",t)}},t.resetProgress=ct,t.scrollToElement=M,t.setProgress=S,t.setSession=T,t.setVisitorId=E,t.skipTour=pt,t.startTour=Y,t.stopTour=Z,t.syncProgress=a,t.throttle=function(t,e){let o;return function(...s){o||(t(...s),o=!0,setTimeout(()=>o=!1,e))}},t.trackEvent=l,t.waitForElement=K,t.waitForElementVisible=async function(t,e=5e3){const o=await K(t,e);if(!o)return null;const s=Date.now();for(;!F(o)&&Date.now()-s<e;)await new Promise(t=>setTimeout(t,100));return F(o)?o:null},Object.defineProperty(t,"__esModule",{value:!0})}),"undefined"!=typeof window&&(window.BotBuilderTours=window.BotBuilderTours||{},Object.assign(window.BotBuilderTours,BotBuilderTours),document.currentScript&&document.currentScript.hasAttribute("data-auto-init"))){var k=document.currentScript.getAttribute("data-api-key");k&&window.BotBuilderTours.init({apiKey:k})}
//# sourceMappingURL=tours-sdk.min.js.map
